{% extends 'images/base.html' %}

{% block title %}{{ product.name }} - Image Host{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="{% url 'category_detail' category.id %}" class="btn" style="margin-bottom: 1rem;">← Back to Category</a>
    <h2>{{ store.name }} → {{ category.name }} → {{ product.name }}</h2>
</div>

<!-- Upload Form -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Upload Images</h3>
    <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        <div class="form-group">
            <label for="image_files">Select Images (Multiple allowed)</label>
            <input type="file" 
                   id="image_files" 
                   name="image_files" 
                   class="form-control" 
                   accept="image/*" 
                   multiple 
                   required>
            <small style="color: #666; font-size: 0.875rem;">You can select multiple images at once</small>
        </div>
        
        <div id="imageLabelsContainer" style="margin-top: 1.5rem; display: none;">
            <h4 style="margin-bottom: 1rem; font-size: 1rem;">Labels and Previews:</h4>
            <div id="labelsList">
                <!-- Each image will have label on left, preview on right -->
            </div>
        </div>
        
        <button type="submit" class="btn btn-success" id="uploadBtn" style="margin-top: 1rem; display: none;">
            Upload Images
        </button>
    </form>
</div>

<!-- Images Display -->
<div class="card">
    <h3 style="margin-bottom: 1rem;">Product Images</h3>
    {% if images %}
        <table id="imagesTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Image Code</th>
                    <th>Image URL</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for image in images %}
                    <tr data-image-id="{{ image.id }}">
                        <td>
                            <img src="{{ image.image_file.url }}" alt="{{ image.name }}" class="image-preview">
                        </td>
                        <td>
                            <span class="editable" contenteditable="true" data-field="name" data-image-id="{{ image.id }}">
                                {{ image.name }}
                            </span>
                        </td>
                        <td>
                            <span class="editable" contenteditable="true" data-field="image_code" data-image-id="{{ image.id }}">
                                {{ image.image_code }}
                            </span>
                        </td>
                        <td>
                            {% for img_data in image_data %}
                                {% if img_data.id == image.id %}
                                    <input type="text" 
                                           value="{{ img_data.url }}" 
                                           readonly 
                                           class="form-control" 
                                           style="font-size: 0.875rem; cursor: pointer;"
                                           onclick="this.select();">
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <button class="btn btn-success save-btn" data-image-id="{{ image.id }}" style="display: none;">Save</button>
                            <a href="{% url 'image_delete' image.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this image?');">Delete</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center; color: #666; padding: 2rem;">
            No images uploaded yet. Upload your first image above!
        </p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Handle multiple image uploads with labels
    const imageFilesInput = document.getElementById('image_files');
    const labelsContainer = document.getElementById('imageLabelsContainer');
    const labelsList = document.getElementById('labelsList');
    const uploadBtn = document.getElementById('uploadBtn');
    
    imageFilesInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        if (files.length === 0) {
            labelsContainer.style.display = 'none';
            uploadBtn.style.display = 'none';
            return;
        }
        
        // Show labels container and upload button
        labelsContainer.style.display = 'block';
        uploadBtn.style.display = 'inline-block';
        
        // Clear previous labels and previews
        labelsList.innerHTML = '';
        
        // Create label input and preview for each file
        files.forEach((file, index) => {
            // Create container for this image row (label on left, preview on right)
            const imageRow = document.createElement('div');
            imageRow.style.cssText = 'display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; align-items: start; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee;';
            
            // Left side: Label and Image Code inputs
            const labelDiv = document.createElement('div');
            labelDiv.className = 'form-group';
            
            const filename = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
            // Generate image code from filename
            const imageCode = filename.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim()
                .replace(/\s/g, '_')
                .replace(/_+/g, '_');
            
            labelDiv.innerHTML = `
                <label for="image_label_${index}" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    Label (for human viewing): <span style="color: #666; font-weight: normal; font-size: 0.875rem;">${file.name}</span>
                </label>
                <input type="text" 
                       id="image_label_${index}" 
                       name="image_labels" 
                       class="form-control" 
                       value="${filename}"
                       placeholder="Enter label for this image"
                       style="margin-bottom: 0.75rem;">
                <label for="image_code_${index}" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
                    Image Code (for programming/API): 
                </label>
                <input type="text" 
                       id="image_code_${index}" 
                       name="image_codes" 
                       class="form-control" 
                       value="${imageCode}"
                       placeholder="Enter image code (auto-generated)"
                       style="font-family: monospace; font-size: 0.9rem;">
                <small style="color: #666; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                    Leave empty to auto-generate from filename
                </small>
            `;
            
            // Right side: Image preview
            const previewDiv = document.createElement('div');
            previewDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; min-width: 220px;';
            previewDiv.innerHTML = `
                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem; font-weight: 500; text-align: center;">Preview</div>
                <img id="preview_${index}" 
                     src="" 
                     alt="Preview" 
                     style="max-width: 200px; max-height: 200px; border: 2px solid #ddd; border-radius: 4px; padding: 4px; background: white; object-fit: contain; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            `;
            
            // Read file and create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById(`preview_${index}`);
                if (previewImg) {
                    previewImg.src = e.target.result;
                }
            };
            reader.readAsDataURL(file);
            
            // Add both to row
            imageRow.appendChild(labelDiv);
            imageRow.appendChild(previewDiv);
            
            labelsList.appendChild(imageRow);
        });
    });

    // Handle editable fields
    const editableFields = document.querySelectorAll('.editable');
    const saveButtons = document.querySelectorAll('.save-btn');
    
    editableFields.forEach(field => {
        field.addEventListener('input', function() {
            const imageId = this.getAttribute('data-image-id');
            const saveBtn = document.querySelector(`.save-btn[data-image-id="${imageId}"]`);
            if (saveBtn) {
                saveBtn.style.display = 'inline-block';
            }
        });
    });

    // Save changes
    saveButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const imageId = this.getAttribute('data-image-id');
            const row = document.querySelector(`tr[data-image-id="${imageId}"]`);
            const nameField = row.querySelector('[data-field="name"]');
            const codeField = row.querySelector('[data-field="image_code"]');
            
            const data = {
                name: nameField.textContent.trim(),
                image_code: codeField.textContent.trim()
            };

            fetch(`/images/${imageId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Update the URL field
                    const urlInput = row.querySelector('input[type="text"]');
                    urlInput.value = result.image.url;
                    
                    // Hide save button
                    this.style.display = 'none';
                    
                    // Show success message
                    alert('Image updated successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the image.');
            });
        });
    });
</script>
{% endblock %}

